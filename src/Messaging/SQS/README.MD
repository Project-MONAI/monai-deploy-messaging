<p align="center">
<img src="https://raw.githubusercontent.com/Project-MONAI/MONAI/dev/docs/images/MONAI-logo-color.png" width="50%" alt='project-monai'>
</p>

ðŸ’¡ If you want to know more about MONAI Deploy WG vision, overall structure, and guidelines, please read [MONAI Deploy](https://github.com/Project-MONAI/monai-deploy) first.

# MONAI Deploy Messaging SQS Plug-In
AWS SQS plugin for the messaging layer of MONAI Deploy.

## Information:
This plugin can be used as an alternative to RabbitMQ. The allows MONAI Deploy to integrate AWS Simple Queue Service. Unlike RabbitMQ SQS does not have a concept of vhost, exchange and routing key; instead the plugin will create one specific queue for each combinatation.

<table>
    <tr>
        <td>
            <b>RMQ plugin</b>
        </td>
        <td>
            <b>SQS plugin</b>
        </td>
        <td><b>Description</b>
        </td>
    </tr>   
    <tr>
        <td>vhost</td>
        <td>environmentId</td>
        <td>The vhost namespace is replaced be the parameter environmentId. This parmater is used as a prefix for each queue name, allowing mutliple MONAI deploy installaiton on the same AWS account with not queue name conflict.</td>
    </tr>
    <tr>
        <td>exchange and routing key</td>
        <td>WorkflowRequestQueue and exportRequestQueue</td>
        <td>These parmaeters control the name of the queues related to each purpose. Each queue name will be suffixed with the name routing key.</td>
    </tr>
</table>

Queue names generated by the plugin have the following convention : environmentId_RequestQueue_routingKey. 
Queue names will be less or equal to 80 characters long. 
Any non-alphanumeircal other that "-" and "\_" found in the environmentId, RequestQueue aprameters or routing key variables will be replaced by "\_".

The queues are created automatically upon the 1st message publication/subscription if not already existing. Because MONAI Deploy can generate payloads greater than 256KBytes, the plugin leverages SQS extended client, allowing payload up to 2GB in size. The use of this specific client mandates the usage of an S3 bucket as transient container for the messages to be held until their delivery to the queue subscriber. More information is available below in this documentation about IAM privileges and S3 bucket requirements. 


    
## Plugin activation

Because MONAI Deploy plugin management is still in being developped (as of 06/13/2022), plugins cannot be loaded at run-time. Instead this SQS pluging can be activated by doing small code changes to the MONAI Informatic Gateway project https://github.com/Project-MONAI/monai-deploy-informatics-gateway, in the `Program.cs` file and recompiling. 

In the declaration for `CreateHostBuilder`, locate the following code block:

                    services.UseRabbitMq();
                    services.AddSingleton<RabbitMqMessagePublisherService>();
                    services.AddSingleton<IMessageBrokerPublisherService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerPublisherService>(logger, options.Value.Messaging.PublisherServiceAssemblyName);
                    });

                    services.AddSingleton<RabbitMqMessageSubscriberService>();
                    services.AddSingleton<IMessageBrokerSubscriberService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerSubscriberService>(logger, options.Value.Messaging.SubscriberServiceAssemblyName);
                    });


and alter it to look like the code below :

                    //services.UseRabbitMq();
                    services.AddSingleton<SQSMessagePublisherService>();
                    services.AddSingleton<IMessageBrokerPublisherService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerPublisherService>(logger, options.Value.Messaging.PublisherServiceAssemblyName);
                    });

                    services.AddSingleton<SqsMessageSubscriberService>();
                    services.AddSingleton<IMessageBrokerSubscriberService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerSubscriberService>(logger, options.Value.Messaging.SubscriberServiceAssemblyName);
                    });

## MONAI Informatic Gateway Configuration

The plugin is configured in the Messaging section of `appsettings.json` / `appsettings.Development.json` :

    "messaging": {
      "publisherServiceAssemblyName": "Monai.Deploy.Messaging.SQS.SQSMessagePublisherService, Monai.Deploy.Messaging",
      "subscriberServiceAssemblyName": "Monai.Deploy.Messaging.SQS.SqsMessageSubscriberService, Monai.Deploy.Messaging",
      "publisherSettings": {
        "bucketName": "monai-minio",
        "workflowRequestQueue": "workflow_tasks",
        "environmentId": "monai-1",
        "accessKey": "ASDFGHJKLADF123456789",
        "accessToken": "QwErTyUiOpAsDonMB88W1mcCCwQdePe8X27SEu1S"
      },
      "subscriberSettings": {
        "exportRequestQueue": "export_tasks",
        "bucketName": "monai-minio",
        "environmentId": "monai-1",
        "accessKey": "ASDFGHJKLADF123456789",
        "accessToken": "QwErTyUiOpAsDonMB88W1mcCCwQdePe8X27SEu1S"
      }
    },

<table>
    <tr>
        <td>bucketName</td>
        <td>S3 bucket used to storage the messages temporarily untul the subscriber gets it.</td>
    </tr>
    <tr>
        <td>workflowRequestQueue</td>
        <td>Queue prefix for the workflow requests ( MIG -> Workflow Manager ). This parameter is only useful in the PublisherSettings section.</td>
    </tr>
    <tr>
        <td>exportRequestQueue</td>
        <td>Queue prefix for the export requests ( Workflow Manager -> MIG ). This parameter is only useful in the SubscriberSettings section.</td>
    </tr>
    <tr>
        <td>bucketName</td>
        <td>S3 bucket used to store the messages temporarily until the subscriber gets it.</td>
    </tr>
    <tr>
        <td>environmentId</td>
        <td>A prefix used to identify the MONAI environment. Allows to create multiple environments within a single AWS account without queue name conflict. This parameter is comparable to the vhost in RabbitMq.</td>
    </tr>
    <tr>
        <td>accessKey</td>
        <td>AWS IAM user access key. This parameter is optional, will be used if present, otherwise the plugin will fallback local credentials, then EC2 role if present. If this parameter is used, the parameter accessToken is also required. Refer to the section IAM privileges for IAM configuration.</td>
    </tr>
    <tr>
        <td>accessToken</td>
        <td>AWS IAM user access token. This parameter is only required when the parameter accesskey is provided.</td>
    </tr>
</table>

##IAM Privileges

For the plugin to function a set of specific privileges need to be provided. This can be associated either with an IAM user ( via accessKey and accessToken ) or by running MONAI on an EC2 instance associated with an IAM Role granted for the following privileges:

## Contributing

For guidance on making a contribution to MONAI Deploy Workflow Manager, see the [contributing guidelines](https://github.com/Project-MONAI/monai-deploy/blob/main/CONTRIBUTING.md).

Join the conversation on Twitter [@ProjectMONAI](https://twitter.com/ProjectMONAI) or join our [Slack channel](https://forms.gle/QTxJq3hFictp31UM9).

Ask and answer questions over on [MONAI Deploy Workflow Manager's GitHub Discussions tab](https://github.com/Project-MONAI/monai-deploy-workflow-manager/discussions).

## Links

- Website: <https://monai.io>
- Code: <https://github.com/Project-MONAI/monai-deploy-messaging>
- Project tracker: <https://github.com/Project-MONAI/monai-deploy-messaging/projects>
- Issue tracker: <https://github.com/Project-MONAI/monai-deploy-messaging/issues>
- Test status: <https://github.com/Project-MONAI/monai-deploy-messaging/actions>
