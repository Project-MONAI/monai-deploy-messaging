<p align="center">
<img src="https://raw.githubusercontent.com/Project-MONAI/MONAI/dev/docs/images/MONAI-logo-color.png" width="50%" alt='project-monai'>
</p>

ðŸ’¡ If you want to know more about MONAI Deploy WG vision, overall structure, and guidelines, please read [MONAI Deploy](https://github.com/Project-MONAI/monai-deploy) first.

# MONAI Deploy Messaging SQS Plug-In
AWS SQS plugin for the messaging layer of MONAI Deploy.

## Information:
This plugin can be used as a messaging mechanism alternative to RabbitMQ, and allows MONAI Deploy to integrate with AWS Simple Queue Service. Unlike RabbitMQ, SQS does not have a concept of vhost, exchange and routing key; instead the plugin will create one specific queue for each vhost, exchange and routing key combibation.

<table>
    <tr>
        <td>
            <b>RMQ plugin</b>
        </td>
        <td>
            <b>SQS plugin</b>
        </td>
        <td><b>Description</b>
        </td>
    </tr>   
    <tr>
        <td>vhost</td>
        <td>environmentId</td>
        <td>The vhost namespace is replaced be the parameter environmentId. This parmater is used as a prefix for each queue name, allowing mutliple MONAI deploy installaiton on the same AWS account with not queue name conflict.</td>
    </tr>
    <tr>
        <td>exchange and routing key</td>
        <td>workflowRequestQueue and exportRequestQueue</td>
        <td>These parmaeters control the name of the queues related to each purpose. Each queue name will be suffixed with the name routing key.</td>
    </tr>
</table>

Queue names generated by the plugin have the following name convention : [environmentId]_[RequestQueue]_[routingKey]. 
Queue names will be less or equal to 80 characters long. 
Any non-alphanumeircal other that "-" and "\_" found in the environmentId, RequestQueue, parameters or routing key variables will be replaced by "\_".

The queues are created automatically upon the 1st message publication/subscription if they do not already exist. Because MONAI Deploy can generate payloads greater than 256KBytes, the plugin leverages the SQS extended client, allowing payload up to 2GB in size. The use of this specific client mandates the usage of an S3 bucket as transient store for the messages to be held until their delivery to the queue subscriber. More information is available below in this documentation about IAM privileges, SQS and S3 bucket requirements. 


    
## Plugin activation

Because MONAI Deploy plugin management work is still in progress (as of 06/13/2022), plugins cannot be loaded at run-time. Instead this SQS pluging can be activated by doing small code changes to the MONAI Informatic Gateway project https://github.com/Project-MONAI/monai-deploy-informatics-gateway, in the `Program.cs` file and recompiling. 

In the declaration for `CreateHostBuilder`, locate the following code block:

                    services.UseRabbitMq();
                    services.AddSingleton<RabbitMqMessagePublisherService>();
                    services.AddSingleton<IMessageBrokerPublisherService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerPublisherService>(logger, options.Value.Messaging.PublisherServiceAssemblyName);
                    });

                    services.AddSingleton<RabbitMqMessageSubscriberService>();
                    services.AddSingleton<IMessageBrokerSubscriberService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerSubscriberService>(logger, options.Value.Messaging.SubscriberServiceAssemblyName);
                    });


and alter it to look like the code below :

                    //services.UseRabbitMq();
                    services.AddSingleton<SQSMessagePublisherService>();
                    services.AddSingleton<IMessageBrokerPublisherService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerPublisherService>(logger, options.Value.Messaging.PublisherServiceAssemblyName);
                    });

                    services.AddSingleton<SqsMessageSubscriberService>();
                    services.AddSingleton<IMessageBrokerSubscriberService>(implementationFactory =>
                    {
                        var options = implementationFactory.GetService<IOptions<InformaticsGatewayConfiguration>>();
                        var serviceProvider = implementationFactory.GetService<IServiceProvider>();
                        var logger = implementationFactory.GetService<ILogger<Program>>();
                        return serviceProvider.LocateService<IMessageBrokerSubscriberService>(logger, options.Value.Messaging.SubscriberServiceAssemblyName);
                    });

## MONAI Informatic Gateway Configuration

The plugin is configured in the Messaging section of `appsettings.json` / `appsettings.Development.json` :

```json
    "messaging": {
      "publisherServiceAssemblyName": "Monai.Deploy.Messaging.SQS.SQSMessagePublisherService, Monai.Deploy.Messaging",
      "subscriberServiceAssemblyName": "Monai.Deploy.Messaging.SQS.SqsMessageSubscriberService, Monai.Deploy.Messaging",
      "publisherSettings": {
        "bucketName": "monai-minio",
        "workflowRequestQueue": "workflow_tasks",
        "environmentId": "monai-1",
        "accessKey": "ASDFGHJKLADF123456789",
        "accessToken": "QwErTyUiOpAsDonMB88W1mcCCwQdePe8X27SEu1S"
      },
      "subscriberSettings": {
        "exportRequestQueue": "export_tasks",
        "bucketName": "monai-minio",
        "environmentId": "monai-1",
        "accessKey": "ASDFGHJKLADF123456789",
        "accessToken": "QwErTyUiOpAsDonMB88W1mcCCwQdePe8X27SEu1S"
      }
    },
```
<table>
    <tr>
        <td>bucketName</td>
        <td>S3 bucket used to store the messages temporarily until the subscriber gets it.</td>
    </tr>
    <tr>
        <td>workflowRequestQueue</td>
        <td>Queue prefix for the workflow requests ( MIG -> Workflow Manager ). This parameter is only useful in the PublisherSettings section.</td>
    </tr>
    <tr>
        <td>exportRequestQueue</td>
        <td>Queue prefix for the export requests ( Workflow Manager -> MIG ). This parameter is only useful in the SubscriberSettings section.</td>
    </tr>
    <tr>
        <td>bucketName</td>
        <td>S3 bucket used to store the messages temporarily until the subscriber gets it.</td>
    </tr>
    <tr>
        <td>environmentId</td>
        <td>A prefix used to identify the MONAI environment. This allows to create multiple environments within a single AWS account without queue name conflict. This parameter allows for a configuration comparable to the vhost concept in RabbitMq.</td>
    </tr>
    <tr>
        <td>accessKey</td>
        <td>AWS IAM user access key. This parameter is optional.If not present the plugin will fallback to local credentials, then EC2 role. If this parameter is used, the parameter accessToken is also required. Refer to the section IAM privileges for IAM configuration.</td>
    </tr>
    <tr>
        <td>accessToken</td>
        <td>AWS IAM user access token. This parameter is only required when the parameter accesskey is provided.</td>
    </tr>
</table>

## IAM Privileges

For the plugin to function a set of specific privileges need to be provided. The permissions can be associated either with an IAM user ( via accessKey and accessToken ) or by running MONAI on an EC2 instance associated with an IAM Role granted for the following privileges:

Replace the tags below in the below policy as follow :

[AWS_Account] : The AWS Account ID ( numeric )
[EnvironmentId] : The Environment Id use int Subscriber and Publisher settings of the Messaging seciton of `appsettings.json` / `appsettings.Development.json`.
[BucketName] : the name of the S3 bucket used to store the messages temporarily.

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "sqs:DeleteMessage",
                "s3:PutObject",
                "s3:GetObject",
                "sqs:GetQueueUrl",
                "sqs:ReceiveMessage",
                "sqs:SendMessage",
                "sqs:GetQueueAttributes",
                "sqs:CreateQueue",
                "s3:DeleteObject",
                "sqs:SetQueueAttributes"
            ],
            "Resource": [
                "arn:aws:sqs:*:[AWS_Account]:[EnvironmentId]",
                "arn:aws:s3:::[BucketName]/*"
            ]
        }
    ]
}
```

## Contributing

For guidance on making a contribution to MONAI Deploy Workflow Manager, see the [contributing guidelines](https://github.com/Project-MONAI/monai-deploy/blob/main/CONTRIBUTING.md).

Join the conversation on Twitter [@ProjectMONAI](https://twitter.com/ProjectMONAI) or join our [Slack channel](https://forms.gle/QTxJq3hFictp31UM9).

Ask and answer questions over on [MONAI Deploy Workflow Manager's GitHub Discussions tab](https://github.com/Project-MONAI/monai-deploy-workflow-manager/discussions).

## Links

- Website: <https://monai.io>
- Code: <https://github.com/Project-MONAI/monai-deploy-messaging>
- Project tracker: <https://github.com/Project-MONAI/monai-deploy-messaging/projects>
- Issue tracker: <https://github.com/Project-MONAI/monai-deploy-messaging/issues>
- Test status: <https://github.com/Project-MONAI/monai-deploy-messaging/actions>
